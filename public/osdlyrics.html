<!DOCTYPE html>
<html lang="en">
<html>

<head>
    <style>
        body {
            font-family: Barlow, -apple-system, BlinkMacSystemFont, Helvetica Neue, PingFang SC, Microsoft YaHei, Source Han Sans SC, Noto Sans CJK SC, WenQuanYi Micro Hei, sans-serif;
            font-weight: 600;
            text-align: center;
            font-size: 28px;
            user-select: none;
            -webkit-user-select: none;
            -webkit-app-region: drag;
        }

        div {
            display: block;
            padding: 9px;
            border-radius: 6px;
            background: hsla(0, 0%, 50.2%, .38);
        }
    </style>
    <title>OSD Lyrics</title>
    <script>
        const electron =
            process.env.IS_ELECTRON === true ? window.require('electron') : null;
        const ipcRenderer =
            process.env.IS_ELECTRON === true ? electron.ipcRenderer : null;
        update_interval = 500;
        song_id = null;
        lyrics = null;
        translation = null;
        interval = null;
        current_line = null;
        function lyric_parser(lrc) {
            lines = lrc
                .split('\n')
                .filter(x => (x.length >= 11))
                .map(x => {
                    nx = decodeURIComponent(x);
                    text = nx.split(']');
                    min = Number(text[0].substring(1, 3));
                    sec = Number(text[0].substring(4));
                    return [min * 60 + sec, text[1]];
                });
            return lines;
        }
        function update_window_size() {
            offsetHeight = document.getElementById('line1').offsetHeight;
            ipcRenderer.send('resizeOSDLyrics', offsetHeight);
        }
        function update_line(progress) {
            if (!lyrics) {
                document.getElementById("line1").innerHTML = "纯音乐，请欣赏";
            }
            else if (interval && progress >= interval[0] && progress < interval[1]) {
            }
            else if (!translation) {
                for (i = 1; i < lyrics.length; i++) {
                    if (progress < lyrics[i][0]) {
                        interval = [lyrics[i - 1][0], lyrics[i][0]];
                        current_line = lyrics[i - 1][1];
                        document.getElementById("line1").innerHTML = current_line;
                        break;
                    }
                }
            }
            else {
                for (i = 1; i < lyrics.length; i++) {
                    if (progress < lyrics[i][0]) {
                        interval = [lyrics[i - 1][0], lyrics[i][0]];
                        current_line = lyrics[i - 1][1];
                        break;
                    }
                }
                for (i = 1; i < translation.length; i++) {
                    if (progress < translation[i][0]) {
                        current_line = current_line + "<br>" + translation[i - 1][1];
                        break;
                    }
                }
                document.getElementById("line1").innerHTML = current_line;
            }
            setTimeout(update_lyrics, update_interval);
        }
        function get_lyrics(_song_id) {
            fetch("http://127.0.0.1:10754/lyric?id=" + _song_id)
                .then(
                    ((_lyric) => {
                        _lyric
                            .text()
                            .then(
                                (text) => {
                                    result = JSON.parse(text);
                                    if (!result.lrc) {
                                        lyrics = null;
                                        translation = null;
                                        return;
                                    }
                                    lyrics = lyric_parser(result.lrc.lyric);
                                    translation = lyric_parser(result.tlyric.lyric);
                                    update_line(_progress);
                                })
                    }))
        }
        function update_lyrics() {
            fetch("http://127.0.0.1:27232/player")
                .then(
                    (player) => {
                        player
                            .text()
                            .then((text) => {
                                _status = JSON.parse(text);
                                _song_id = _status.currentTrack.id;
                                _progress = _status.progress;
                                if (_song_id !== song_id) {
                                    song_id = _song_id;
                                    interval = null;
                                    get_lyrics(_song_id);
                                }
                                else {
                                    update_line(_progress);
                                }
                            })
                    });
        }
    </script>
</head>

<body onload="update_lyrics()">
    <div id="line1">YesPlayMusic</div>
</body>

</html>